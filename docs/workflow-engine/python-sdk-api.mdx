---
sidebar_position: 3
---

import python_df from '@site/static/img/docs/python_df.png';
import python_plt from '@site/static/img/docs/python_plt.png';
import python_plotly from '@site/static/img/docs/python_plotly.png';

# ðŸ“™ Python API

## 1. Introduction

Developers will call our SDK in  `Scriptlet` to interact with the `OOCANA` workflow engine.

## 2. `Context` Object

How to use the SDK in Scriptlet.

```python
from oocana import Context
from typing import Any

def main(inputs: dict, context: Context):
    # Report Block done.
    context.done(err: str | None)
    # Report logs
    context.log_JSON(payload: Any)
    # Report error.
    context.send_error()
    # Report extra Block messages.
    context.send_message()
    # Send to Preview
    context.preview(payload: PreviewPayload)
    # Report Block's stdio and stdout message.
    context.report_log(line: str, stdio: str = "stdout" | "stderr")
    # Report progress, progress 1 ~ 100
    context.report_progress(progress: float | int)
    return { "out": None }

```

## 3. `Context` Types

API type descriptions provided by the `OOCANA` SDK, help users know how to use these APIs accurately.

```python

class Context:

    @property
    def keepAlive(self):
        return self.__keep_alive

    @property
    def inputs(self):
        return self.__inputs

    @property
    def session_id(self):
        return self.__block_info.session_id

    @property
    def job_id(self):
        return self.__block_info.job_id
    
    @property
    def job_info(self) -> JobDict:
        return self.__block_info.job_info()
    
    @property
    def block_info(self) -> BlockDict:
        return self.__block_info.block_dict()
    
    @property
    def node_id(self) -> str:
        return self.__block_info.stacks[-1].get("node_id", None)

    def output(self, key: str, value: Any, done: bool = False):

    def done(self, error: str | None = None):
        if self.__is_done:
            return
        self.__is_done = True
        if error is None:
            self.__mainframe.send(self.job_info, {"type": "BlockFinished"})
        else:
            self.__mainframe.send(
                self.job_info, {"type": "BlockFinished", "error": error}
            )

    def send_message(self, payload):
        self.__mainframe.report(
            self.block_info,
            {
                "type": "BlockMessage",
                "payload": payload,
            },
        )

    def preview(self, payload: PreviewPayload):
        payload = self.__dataframe(payload)
        payload = self.__matplotlib(payload)

        self.__mainframe.report(
            self.block_info,
            {
                "type": "BlockPreview",
                "payload": payload,
            },
        )

    @throttle(0.3)
    def report_progress(self, progress: float | int):
        self.__mainframe.report(
            self.block_info,
            {
                "type": "BlockProgress",
                "rate": progress,
            }
        )

    def report_log(self, line: str, stdio: str = "stdout"):
        self.__mainframe.report(
            self.block_info,
            {
                "type": "BlockLog",
                "log": line,
                stdio: stdio,
            },
        )

    def log_json(self, payload):
        self.__mainframe.report(
            self.block_info,
            {
                "type": "BlockLogJSON",
                "json": payload,
            },
        )

    def send_error(self, error: str):
        self.__mainframe.send(self.job_info, {"type": "BlockError", "error": error})

```

## 4. `Context.preview` Types

`context.preview` is the core API. Its main function is to help developers preview data. We support the preview of almost all commonly used data.

### 4.1 `PreviewPayload` Types

```python
    def preview(self, payload: PreviewPayload):
    # python only
    payload = self.__dataframe(payload)
    # python only
    payload = self.__matplotlib(payload)

    self.__mainframe.report(
        self.block_info,
        {
            "type": "BlockPreview",
            "payload": payload,
        },
    )
```

```python
    
    from typing import Any, TypedDict, List, Literal, TypeAlias, Union

    class TablePreviewData(TypedDict):
        columns: List[str | int | float]
        rows: List[List[str | int | float | bool]]
        row_count: int | None

    class TablePreviewPayload(TypedDict):
        type: Literal['table']
        data: TablePreviewData | Any

    class TextPreviewPayload(TypedDict):
        type: Literal["text"]
        data: Any

    class JSONPreviewPayload(TypedDict):
        type: Literal["json"]
        data: Any

    class ImagePreviewPayload(TypedDict):
        type: Literal['image']
        data: str | List[str]

    class MediaPreviewPayload(TypedDict):
        type: Literal["image", 'video', 'audio', 'markdown', "iframe", "html"]
        data: str

    class DefaultPreviewPayload:
        type: str
        data: Any

    PreviewPayload: TypeAlias = Union[
        TablePreviewPayload,
        TextPreviewPayload,
        JSONPreviewPayload,
        ImagePreviewPayload,
        MediaPreviewPayload,
        DefaultPreviewPayload
    ]

```

### 4.2 `Preview` Example

```python
  context.preview({
    # type can be "image", "video", "audio", "markdown", "table", "iframe"
    "type": "video",
    # data can be file path, base64, pandas dataframe
    "data": "https://www.w3schools.com/html/mov_bbb.mp4"
  })
```

:::tip
Python Only
:::

```python
    import pandas as pd

    df = pd.DataFrame({
        'A': [1, 2, 3],
        'B': [4, 5, 6],
        'C': [7, 8, 9]
    })
     context.preview(df)
```

<img src={python_df} width="720" />

```python
    import matplotlib.pyplot as plt
    import numpy as np

    x = np.linspace(0, 10, 100)
    y = np.sin(x)
    plt.plot(x, y)
    plt.show()
```
<img src={python_plt} width="720" />

```python
    import plotly.graph_objects as go

    fig = go.Figure(data=[go.Bar(y=[2, 3, 1])])
    fig.show()
```

<img src={python_plotly} width="720" />