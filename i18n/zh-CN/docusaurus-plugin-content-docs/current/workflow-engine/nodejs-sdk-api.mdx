---
sidebar_position: 2
---

import node_preview from "@site/static/img/docs/node_preview.png";

# ğŸ“— Nodejs API

## è§†é¢‘æ•™ç¨‹

<iframe
  src="//player.bilibili.com/player.html?bvid=BV1DbAceXE42&autoplay=0&vd_source=074e15df4d816e8ebbec8bdbdf4d6925#reply256944692752"
  scrolling="no"
  frameborder="no"
  framespacing="0"
  allowfullscreen
  width="720"
  height="480"
/>

## å›¾æ–‡è¯´æ˜

## 1. ç®€ä»‹

å¼€å‘äººå‘˜å°†åœ¨ Scriptlet Block ä¸­è°ƒç”¨æˆ‘ä»¬çš„ SDK ä¸ `OOCANA` å·¥ä½œæµå¼•æ“è¿›è¡Œäº¤äº’ã€‚

## 2. å¿«é€Ÿå¼€å§‹

åœ¨ Scriptlet Block ä¸­ä½¿ç”¨ SDK, ä½ éœ€è¦å¯¼å…¥ `Context` å¯¹è±¡ï¼Œç„¶åä½¿ç”¨ `Context` å¯¹è±¡ä¸­çš„ APIã€‚

### 2.1 `Scriptlet` æ¨¡æ¿

æ¨¡æ¿æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œéœ€è¦æ‰§è¡Œçš„ä»£ç å†™åœ¨å‡½æ•°ä¸­ã€‚å‡½æ•°çš„è¾“å…¥å’Œè¾“å‡ºç±»å‹ç”±ç”¨æˆ·è‡ªå®šä¹‰ã€‚ä¹Ÿæ”¯æŒå®‰è£…ç¬¬ä¸‰æ–¹åº“ï¼Œç›´æ¥å’Œæ­£å¸¸å¼€å‘ä¸€æ ·å¼•ç”¨å°±å¯ä»¥ã€‚

```typescript
import type { Context } from "@oomol/types/oocana";

type Inputs = {
  input: unknown;
};
type Outputs = {
  output: unknown;
};

export default async function (
  params: Inputs,
  context: Context<Inputs, Outputs>
): Promise<Outputs> {
  // ä½ çš„ä»£ç å†™åœ¨æ­¤å¤„ï¼Œä¼šè¢«æ‰§è¡Œ

  return { output: null };
}
```

### 2.2 å¸¸ç”¨ API

å¸¸ç”¨çš„ API åˆ—è¡¨å¦‚ä¸‹ï¼š

```typescript
  /** æŠ¥å‘ŠåŒºå—å·²å®Œæˆ */
  readonly done: (err?: any) => Promise<void>;
  /** æŠ¥å‘Šé”™è¯¯ */
  readonly error: (error: unknown) => Promise<void>;
  /** å¯ç”¨é¢„è§ˆ */
  readonly preview: (payload: PreviewPayload) => Promise<void>;
  /** æ¯æ¬¡ä»»åŠ¡çš„ä¸´æ—¶ç›®å½•ï¼Œ ç”¨æˆ·å¯ä»¥ç”¨æ¥å­˜å‚¨ä¸´æ—¶æ–‡ä»¶ */
  readonly sessionDir: string;
  /** æŠ¥å‘Šè¿›åº¦ï¼Œè¿›åº¦0~100ï¼Œè¯¥å‡½æ•°æœ‰èŠ‚æµæ•ˆæœï¼Œæ¯300msè§¦å‘ä¸€æ¬¡ã€‚ */
  readonly reportProgress: (progress: number) => Promise<void>;
  /** è·å– OOMOL å†…ç½®å¤§æ¨¡å‹ï¼Œå¯ä»¥è·å– base_url api-key model-list */
  readonly OOMOL_LLM_ENV: OOMOL_LLM_ENV;
```

## 3. `Context.preview` Types

`context.preview` æ˜¯æ ¸å¿ƒ API ã€‚å®ƒçš„ä¸»è¦åŠŸèƒ½æ˜¯å¸®åŠ©å¼€å‘äººå‘˜é¢„è§ˆæ•°æ®ã€‚æˆ‘ä»¬æ”¯æŒå‡ ä¹æ‰€æœ‰å¸¸ç”¨æ•°æ®çš„é¢„è§ˆã€‚

### 3.1 `PreviewPayload` Types

å‡½æ•°åç§°ï¼š`context.preview`

```typescript
    readonly preview: (payload: PreviewPayload) => Promise<void>;
```

å‚æ•°ç±»å‹ï¼š`PreviewPayload`

```typescript
type PreviewPayload =
  | {
      type: "video" | "audio" | "markdown" | "iframe" | "html";
      data: string;
    }
  | {
      type: "json" | "text" | `text/${string}`;
      data: any;
    }
  | {
      type: "image";
      data: string | string[];
    }
  | {
      type: "table";
      data: {
        columns: Array<string | number>;
        rows: Array<Array<string | number | boolean>>;
        row_count?: number;
      };
    };
```

### 3.2 `Preview` ä¾‹å­

```typescript
await context.preview({
  type: "video",
  data: "https://www.youtube.com/watch?v=6g4dkBF5anU",
});
```

<img src={node_preview} width="720" />

## 4. `Context` å¯¹è±¡ç±»å‹çš„è¯¦ç»†ç±»å‹ï¼Œ

`OOCANA` SDK æä¾›çš„ API ç±»å‹æè¿°ï¼Œå¸®åŠ©ç”¨æˆ·äº†è§£å¦‚ä½•å‡†ç¡®ä½¿ç”¨è¿™äº› APIã€‚å¯ä»¥åœ¨ç¼–è¾‘å™¨ä¸­æ‰“å¼€çœ‹åˆ°è¯¦ç»†çš„ç±»å‹æç¤ºã€‚

```typescript
interface Context<
  TInputs = Record<string, any>,
  TOutputs = Record<string, any>,
> {
  readonly sessionId: string;
  readonly jobId: string;
  readonly block_path: string;
  readonly stacks: readonly BlockJobStackLevel[];
  readonly inputs: TInputs;
  readonly output: {
    <THandle extends Extract<keyof TOutputs, string>>(
      handle: THandle,
      output: TOutputs[THandle]
    ): Promise<void>;
    /**
     * @deprecated æ­¤æ–¹æ³•å°†åœ¨æœªæ¥ç§»é™¤ã€‚è¯·ä½¿ç”¨ä¸å¸¦ done å‚æ•°çš„å‡½æ•°ã€‚å¦‚æœæ‚¨æƒ³æŠ¥å‘Šå—å®Œæˆï¼Œè¯·ä½¿ç”¨ context.done()ã€‚
     * æŠ¥å‘Šå—è¾“å‡ºã€‚
     * @param handle è¾“å‡ºå¥æŸ„
     * @param output è¾“å‡ºå€¼
     * @param done å°†è¢«ç§»é™¤ã€‚æŠ¥å‘Šå—å®Œæˆã€‚
     */
    <THandle extends Extract<keyof TOutputs, string>>(
      handle: THandle,
      output: TOutputs[THandle],
      done: boolean
    ): Promise<void>;
  };
  /** æŠ¥å‘Šå—å·²å®Œæˆ */
  readonly done: (err?: any) => Promise<void>;
  /** æŠ¥å‘Šæ—¥å¿— */
  readonly logJSON: (jsonValue: unknown) => Promise<void>;
  /** æŠ¥å‘Šé”™è¯¯ */
  readonly error: (error: unknown) => Promise<void>;
  /** æŠ¥å‘Šé¢å¤–çš„å—æ¶ˆæ¯ */
  readonly sendMessage: (payload: unknown) => Promise<void>;
  /** å‘é€åˆ°é¢„è§ˆ */
  readonly preview: (payload: PreviewPayload) => Promise<void>;
  /** æŠ¥å‘Šå—çš„ stdio å’Œ stdout æ¶ˆæ¯ */
  readonly reportLog: (
    payload: string,
    stdio: "stdout" | "stderr"
  ) => Promise<void>;
  /** æ•´ä¸ªä¼šè¯çš„ä¸´æ—¶ç›®å½•ï¼Œæ‰€æœ‰å—åœ¨ä¸€ä¸ªä¼šè¯ä¸­å°†å…±äº«åŒä¸€ä¸ªç›®å½• */
  readonly sessionDir: string;
  /** æŠ¥å‘Šè¿›åº¦ï¼Œè¿›åº¦ 0 ~ 100ï¼Œè¯¥å‡½æ•°æœ‰èŠ‚æµæ•ˆæœï¼Œæ¯ 300ms è§¦å‘ä¸€æ¬¡ */
  readonly reportProgress: (progress: number) => Promise<void>;
  readonly keepAlive: KeepAlive;
}
```
