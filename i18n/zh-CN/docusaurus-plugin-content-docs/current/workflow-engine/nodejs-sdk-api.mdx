---
sidebar_position: 2
---

import node_preview from "@site/static/img/docs/node_preview.png";

# ğŸ“— Nodejs API

## 1. ç®€ä»‹

å¼€å‘äººå‘˜å°†åœ¨ Scriptlet Block ä¸­è°ƒç”¨æˆ‘ä»¬çš„SDKä»¥ä¸ `OOCANA` å·¥ä½œæµå¼•æ“è¿›è¡Œäº¤äº’ã€‚

## 2. `Context` Object

å¦‚ä½•åœ¨ Scriptlet Block ä¸­ä½¿ç”¨ SDKã€‚

```typescript
import type { Context } from "@oomol/types/oocana";

type Inputs = Readonly<{ in: unknown }>;
type Outputs = Readonly<{ out: unknown }>;

export default async function (
  inputs: Inputs,
  context: Context<Inputs, Outputs>
): Promise<Outputs> {
  /** Report Block done. */
  readonly done: (err?: any) => Promise<void>;

  /** Report logs */
  readonly logJSON: (jsonValue: unknown) => Promise<void>;

  /** Report error. */
  readonly error: (error: unknown) => Promise<void>;

  /** Report extra Block messages. */
  readonly sendMessage: (payload: unknown) => Promise<void>;

  /** Send to Preview */
  readonly preview: (payload: PreviewPayload) => Promise<void>;

  /** Report Block's stdio and stdout message. */
  readonly reportLog: (
    payload: string,
    stdio: "stdout" | "stderr"
  ) => Promise<void>;

  /** a temporary directory for whole session. all block in one session will share the same directory */
  readonly sessionDir: string;

  /** Report progress, progress 0 ~ 100, This function has a throttle effect, triggering once every 300ms. */
  readonly reportProgress: (progress: number) => Promise<void>;

  return { out: inputs };
}
```

## 3. `Context` Types

`OOCANA` SDK æä¾›çš„ API ç±»å‹æè¿°ï¼Œå¸®åŠ©ç”¨æˆ·äº†è§£å¦‚ä½•å‡†ç¡®ä½¿ç”¨è¿™äº› APIã€‚

```typescript
interface Context<
  TInputs = Record<string, any>,
  TOutputs = Record<string, any>,
> {
  readonly sessionId: string;
  readonly jobId: string;
  readonly block_path: string;
  readonly stacks: readonly BlockJobStackLevel[];
  readonly inputs: TInputs;
  readonly output: {
    <THandle extends Extract<keyof TOutputs, string>>(
      handle: THandle,
      output: TOutputs[THandle]
    ): Promise<void>;
    /**
     * @deprecated this method will be removed in the future. please use function without done parameter. if you want to report block done, please use context.done() instead.
     * Report Block output.
     * @param handle Output handle
     * @param output Output value
     * @param done will remove. Report Block done.
     */
    <THandle extends Extract<keyof TOutputs, string>>(
      handle: THandle,
      output: TOutputs[THandle],
      done: boolean
    ): Promise<void>;
  };
  /** Report Block done. */
  readonly done: (err?: any) => Promise<void>;
  /** Report logs */
  readonly logJSON: (jsonValue: unknown) => Promise<void>;
  /** Report error. */
  readonly error: (error: unknown) => Promise<void>;
  /** Report extra Block messages. */
  readonly sendMessage: (payload: unknown) => Promise<void>;
  /** Send to Preview */
  readonly preview: (payload: PreviewPayload) => Promise<void>;
  /** Report Block's stdio and stdout message. */
  readonly reportLog: (
    payload: string,
    stdio: "stdout" | "stderr"
  ) => Promise<void>;
  /** Report progress, progress 0 ~ 100, This function has a throttle effect, triggering once every 300ms. */
  readonly reportProgress: (progress: number) => Promise<void>;
  readonly keepAlive: KeepAlive;
}
```

## 4. `Context.preview` Types

`context.preview()` æ˜¯æ ¸å¿ƒ API ã€‚å®ƒçš„ä¸»è¦åŠŸèƒ½æ˜¯å¸®åŠ©å¼€å‘äººå‘˜é¢„è§ˆæ•°æ®ã€‚æˆ‘ä»¬æ”¯æŒå‡ ä¹æ‰€æœ‰å¸¸ç”¨æ•°æ®çš„é¢„è§ˆã€‚

### 4.1 `PreviewPayload` Types

```typescript
    readonly preview: (payload: PreviewPayload) => Promise<void>;
```

```typescript
type PreviewPayload =
  | {
      type: "video" | "audio" | "markdown" | "iframe" | "html";
      data: string;
    }
  | {
      type: "image";
      data: string | string[];
    }
  | {
      type: "table";
      data: {
        columns: Array<string | number>;
        rows: Array<Array<string | number | boolean>>;
        row_count?: number;
      };
    };
```

### 4.2 `Preview` ä¾‹å­

```typescript
await context.preview({
  type: "video",
  data: "https://www.youtube.com/watch?v=6g4dkBF5anU",
});
```

<img src={node_preview} width="720" />
